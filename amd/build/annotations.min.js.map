{"version":3,"file":"annotations.min.js","sources":["../src/annotations.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for the annotation functions of the margic.\n *\n * @module     mod_margic/annotations\n * @copyright  2022 coactum GmbH\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport {removeAllTempHighlights, anchor, describe} from './highlighting';\n\nexport const init = (cmid, canmakeannotations, myuserid) => {\n\n    var edited = false;\n    var annotations = Array();\n\n    var newannotation = false;\n\n    // Hide all Moodle forms.\n    $('.annotation-form').hide();\n\n    // Remove col-mds from moodle form.\n    $('.annotation-form div.col-md-3').removeClass('col-md-3');\n    $('.annotation-form div.col-md-9').removeClass('col-md-9');\n    $('.annotation-form div.form-group').removeClass('form-group');\n    $('.annotation-form div.row').removeClass('row');\n\n    // Onclick listener if form is canceled.\n    $(document).on('click', '#id_cancel', function(e) {\n        e.preventDefault();\n\n        removeAllTempHighlights(); // Remove other temporary highlights.\n\n        resetForms(); // Remove old form contents.\n\n        edited = false;\n    });\n\n    // Listen for return key pressed to submit annotation form.\n    $('textarea').keypress(function(e) {\n        if (e.which == 13) {\n            $(this).parents(':eq(2)').submit();\n            e.preventDefault();\n        }\n    });\n\n    // If user selects text for new annotation\n    $(document).on('mouseup', '.originaltext', function() {\n        var selectedrange = window.getSelection().getRangeAt(0);\n\n        if (selectedrange.cloneContents().textContent !== '' && canmakeannotations) {\n\n            // console.log('mouseup in originaltext');\n\n            removeAllTempHighlights(); // Remove other temporary highlights.\n\n            resetForms(); // Reset the annotation forms.\n\n            // Create new annotation.\n            newannotation = createAnnotation(this);\n\n            var entry = this.id.replace(/entry-/, '');\n\n            // RangeSelector.\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(\n                newannotation.target[0].selector[0].startContainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(\n                newannotation.target[0].selector[0].endContainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(\n                newannotation.target[0].selector[0].startOffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(\n                newannotation.target[0].selector[0].endOffset);\n\n            // TextPositionSelector.\n            $('.annotation-form-' + entry + ' input[name=\"start\"]').val(\n                newannotation.target[0].selector[1].start);\n            $('.annotation-form-' + entry + ' input[name=\"end\"]').val(\n                newannotation.target[0].selector[1].end);\n\n            // TextQuoteSelector.\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(\n                newannotation.target[0].selector[2].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(\n                newannotation.target[0].selector[2].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(\n                newannotation.target[0].selector[2].suffix);\n\n            $('.annotation-form-' + entry + ' select').val(1);\n\n            $('#annotationpreview-temp-' + entry).html(newannotation.target[0].selector[2].exact);\n\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotation-form-' + entry + ' #id_text').focus();\n        }\n    });\n\n    // Fetch and recreate annotations.\n    $.ajax({\n        url: './annotations.php',\n        data: {'id': cmid, 'getannotations': 1},\n        success: function(response) {\n            annotations = JSON.parse(response);\n            recreateAnnotations();\n\n            // Highlight annotation and all annotated text if annotated text is hovered\n            $('.annotated').mouseenter(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).addClass('hovered');\n                $('.annotated-' + id).addClass('hovered');\n            });\n\n            $('.annotated').mouseleave(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).removeClass('hovered');\n                $('.annotated-' + id).removeClass('hovered');\n            });\n\n            // Highlight whole temp annotation if part of temp annotation is hovered\n            $(document).on('mouseover', '.annotated_temp', function() {\n                $('.annotated_temp').addClass('hovered');\n            });\n\n            $(document).on('mouseleave', '.annotated_temp', function() {\n                $('.annotated_temp').removeClass('hovered');\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.annotated', function() {\n                var id = this.id.replace('annotated-', '');\n                editAnnotation(id);\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.edit-annotation', function() {\n                var id = this.id.replace('edit-annotation-', '');\n                editAnnotation(id);\n            });\n\n            // Highlight annotation if hoverannotation button is hovered\n            $(document).on('mouseover', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).addClass('hovered');\n            });\n\n            $(document).on('mouseleave', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).removeClass('hovered');\n            });\n\n        },\n        error: function() {\n            alert ('Error fetiching annotations');\n        }\n    });\n\n    /**\n     * Recreate annotations.\n     *\n     */\n    function recreateAnnotations() {\n\n        for (let annotation of Object.values(annotations)) {\n\n            const rangeSelectors = [[\n                {type: \"RangeSelector\", startContainer: annotation.startcontainer, startOffset: annotation.startoffset,\n                endContainer: annotation.endcontainer, endOffset: annotation.endoffset},\n                {type: \"TextPositionSelector\", start: annotation.start, end: annotation.end},\n                {type: \"TextQuoteSelector\", exact: annotation.exact, prefix: annotation.prefix, suffix: annotation.suffix}\n            ]];\n\n            // console.log('rangeSelectors');\n            // console.log(rangeSelectors);\n\n            const target = rangeSelectors.map(selectors => ({\n                selector: selectors,\n            }));\n\n            // console.log('target');\n            // console.log(target);\n\n            /** @type {AnnotationData} */\n            const newannotation = {\n                annotation: annotation,\n                target: target,\n            };\n\n            // console.log(newannotation);\n\n            anchor(newannotation, $(\"#entry-\" + annotation.entry)[0]);\n\n            $('#annotationpreview-' + annotation.id).html(annotation.exact);\n        }\n    }\n\n    /**\n     * Edit annotation.\n     *\n     * @param {int} annotationid\n     */\n    function editAnnotation(annotationid) {\n\n        if (edited == annotationid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n            edited = false;\n        } else if (canmakeannotations && myuserid == annotations[annotationid].userid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n\n            edited = annotationid;\n\n            var entry = annotations[annotationid].entry;\n\n            $('.annotation-box-' + annotationid).hide(); // Hide edited annotation-box.\n\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(annotations[annotationid].startcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(annotations[annotationid].endcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(annotations[annotationid].startoffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(annotations[annotationid].endoffset);\n            $('.annotation-form-' + entry + ' input[name=\"start\"]').val(annotations[annotationid].start);\n            $('.annotation-form-' + entry + ' input[name=\"end\"]').val(annotations[annotationid].end);\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(annotations[annotationid].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(annotations[annotationid].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(annotations[annotationid].suffix);\n\n            $('.annotation-form-' + entry + ' input[name=\"annotationid\"]').val(annotationid);\n\n            $('.annotation-form-' + entry + ' textarea[name=\"text\"]').val(annotations[annotationid].text);\n\n            $('.annotation-form-' + entry + ' select').val(annotations[annotationid].type);\n\n            $('#annotationpreview-temp-' + entry).html($('#annotationpreview-' + annotationid).html());\n            $('#annotationpreview-temp-' + entry).css('border-color', '#' + annotations[annotationid].color);\n\n            $('.annotationarea-' + entry + ' .annotation-form').insertBefore('.annotation-box-' + annotationid);\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotationarea-' + entry + ' #id_text').focus();\n        } else {\n            $('.annotation-box-' + annotationid).focus();\n        }\n    }\n\n    /**\n     * Reset all annotation forms\n     */\n    function resetForms() {\n        $('.annotation-form').hide();\n\n        $('.annotation-form input[name^=\"annotationid\"]').val(null);\n\n        $('.annotation-form input[name^=\"startcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"endcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"startoffset\"]').val(-1);\n        $('.annotation-form input[name^=\"endoffset\"]').val(-1);\n\n        $('.annotation-form textarea[name^=\"text\"]').val('');\n\n        $('.annotation-box').not('.annotation-form').show(); // To show again edited annotation.\n    }\n};\n\n/**\n * Create a new annotation that is associated with the selected region of\n * the current document.\n *\n * @param {object} root - The root element\n * @return {object} - The new annotation\n */\nfunction createAnnotation(root) {\n    // console.log('createAnnotation');\n\n    const ranges = [window.getSelection().getRangeAt(0)];\n\n    // console.log('ranges');\n    // console.log(ranges);\n\n    if (ranges.collapsed) {\n        return null;\n    }\n\n    //const info = await this.getDocumentInfo();\n    const rangeSelectors = ranges.map(range => describe(root, range));\n\n    // console.log('rangeSelectors');\n    // console.log(rangeSelectors);\n\n    const target = rangeSelectors.map(selectors => ({\n      selector: selectors,\n    }));\n\n    // console.log('target');\n    // console.log(target);\n\n    /** @type {AnnotationData} */\n    const annotation = {\n      target,\n    };\n\n    // console.log('TARGET INFORMATION TO SAVE IN THE DB');\n    // console.log(annotation);\n\n    anchor(annotation, root);\n\n    // console.log('TEMP');\n    // console.log(temp);\n\n    return annotation;\n}"],"names":["cmid","canmakeannotations","myuserid","edited","annotations","Array","newannotation","editAnnotation","annotationid","resetForms","userid","entry","hide","val","startcontainer","endcontainer","startoffset","endoffset","start","end","exact","prefix","suffix","text","type","html","css","color","insertBefore","show","focus","not","removeClass","document","on","e","preventDefault","keypress","which","this","parents","submit","window","getSelection","getRangeAt","cloneContents","textContent","root","ranges","collapsed","annotation","target","map","range","selectors","selector","createAnnotation","id","replace","startContainer","endContainer","startOffset","endOffset","ajax","url","data","success","response","JSON","parse","Object","values","recreateAnnotations","mouseenter","addClass","mouseleave","error","alert"],"mappings":"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"}