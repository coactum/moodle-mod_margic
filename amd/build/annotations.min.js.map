{"version":3,"file":"annotations.min.js","sources":["../src/annotations.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for the annotation functions of the margic.\n *\n * @module     mod_margic/annotations\n * @copyright  2022 coactum GmbH\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport {removeAllTempHighlights, anchor, describe} from './highlighting';\n\nexport const init = (cmid, canmakeannotations, myuserid, focusannotation) => {\n\n    var edited = false;\n    var annotations = Array();\n\n    var newannotation = false;\n\n    // Remove col-mds from moodle form.\n    $('.annotation-form div.col-md-3').removeClass('col-md-3');\n    $('.annotation-form div.col-md-9').removeClass('col-md-9');\n    $('.annotation-form div.form-group').removeClass('form-group');\n    $('.annotation-form div.row').removeClass('row');\n\n    // Onclick listener if form is canceled.\n    $(document).on('click', '#id_cancel', function(e) {\n        e.preventDefault();\n\n        removeAllTempHighlights(); // Remove other temporary highlights.\n\n        resetForms(); // Remove old form contents.\n\n        edited = false;\n    });\n\n    // Listen for return key pressed to submit annotation form.\n    $('textarea').keypress(function(e) {\n        if (e.which == 13) {\n            $(this).parents(':eq(2)').submit();\n            e.preventDefault();\n        }\n    });\n\n    // If user selects text for new annotation\n    $(document).on('mouseup', '.originaltext', function() {\n        var selectedrange = window.getSelection().getRangeAt(0);\n\n        if (selectedrange.cloneContents().textContent !== '' && canmakeannotations) {\n\n            removeAllTempHighlights(); // Remove other temporary highlights.\n\n            resetForms(); // Reset the annotation forms.\n\n            // Create new annotation.\n            newannotation = createAnnotation(this);\n\n            var entry = this.id.replace(/entry-/, '');\n\n            // RangeSelector.\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(\n                newannotation.target[0].selector[0].startContainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(\n                newannotation.target[0].selector[0].endContainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(\n                newannotation.target[0].selector[0].startOffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(\n                newannotation.target[0].selector[0].endOffset);\n\n            // TextPositionSelector.\n            $('.annotation-form-' + entry + ' input[name=\"annotationstart\"]').val(\n                newannotation.target[0].selector[1].annotationstart);\n            $('.annotation-form-' + entry + ' input[name=\"annotationend\"]').val(\n                newannotation.target[0].selector[1].annotationend);\n\n            // TextQuoteSelector.\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(\n                newannotation.target[0].selector[2].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(\n                newannotation.target[0].selector[2].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(\n                newannotation.target[0].selector[2].suffix);\n\n            $('.annotation-form-' + entry + ' select').val(1);\n\n            // Prevent JavaScript injection (if annotated text in original entry is JavaScript code in script tags).\n            $('#annotationpreview-temp-' + entry).html(\n                newannotation.target[0].selector[2].exact.replaceAll('<', '&lt;').replaceAll('>', '&gt;'));\n\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotation-form-' + entry + ' #id_text').focus();\n        }\n    });\n\n    // Fetch and recreate annotations.\n    $.ajax({\n        url: './annotations.php',\n        data: {'id': cmid, 'getannotations': 1},\n        success: function(response) {\n            annotations = JSON.parse(response);\n            recreateAnnotations();\n\n            // Highlight annotation and all annotated text if annotated text is hovered\n            $('.annotated').mouseenter(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).addClass('hovered');\n                $('.annotated-' + id).css(\"background-color\", 'lightblue');\n            });\n\n            $('.annotated').mouseleave(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).removeClass('hovered');\n                $('.annotated-' + id).css(\"background-color\", $('.annotated-' + id).css('textDecorationColor'));\n            });\n\n            // Highlight whole temp annotation if part of temp annotation is hovered\n            $(document).on('mouseover', '.annotated_temp', function() {\n                $('.annotated_temp').addClass('hovered');\n            });\n\n            $(document).on('mouseleave', '.annotated_temp', function() {\n                $('.annotated_temp').removeClass('hovered');\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.annotated', function() {\n                var id = this.id.replace('annotated-', '');\n                editAnnotation(id);\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.edit-annotation', function() {\n                var id = this.id.replace('edit-annotation-', '');\n                editAnnotation(id);\n            });\n\n            // Highlight annotation if hoverannotation button is hovered\n            $(document).on('mouseover', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).css(\"background-color\", 'lightblue');\n            });\n\n            $(document).on('mouseleave', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).css(\"background-color\", $('.annotated-' + id).css('textDecorationColor'));\n            });\n\n\n            // Focus annotation if needed.\n            if (focusannotation != 0) {\n                $('.annotated-' + focusannotation).attr('tabindex', -1);\n                $('.annotated-' + focusannotation).focus();\n            }\n\n        },\n        complete: function() {\n            $('#overlay').hide();\n        },\n        error: function() {\n            // For output: alert('Error fetching annotations');\n        }\n    });\n\n    /**\n     * Recreate annotations.\n     *\n     */\n    function recreateAnnotations() {\n\n        for (let annotation of Object.values(annotations)) {\n\n            const rangeSelectors = [[\n                {type: \"RangeSelector\", startContainer: annotation.startcontainer, startOffset: parseInt(annotation.startoffset),\n                endContainer: annotation.endcontainer, endOffset: parseInt(annotation.endoffset)},\n                {type: \"TextPositionSelector\", annotationstart: parseInt(annotation.annotationstart),\n                annotationend: parseInt(annotation.annotationend)},\n                {type: \"TextQuoteSelector\", exact: annotation.exact, prefix: annotation.prefix, suffix: annotation.suffix}\n            ]];\n\n            const target = rangeSelectors.map(selectors => ({\n                selector: selectors,\n            }));\n\n            /** @type {AnnotationData} */\n            const newannotation = {\n                annotation: annotation,\n                target: target,\n            };\n\n            anchor(newannotation, $(\"#entry-\" + annotation.entry)[0]);\n        }\n    }\n\n    /**\n     * Edit annotation.\n     *\n     * @param {int} annotationid\n     */\n    function editAnnotation(annotationid) {\n\n        if (edited == annotationid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n            edited = false;\n        } else if (canmakeannotations && myuserid == annotations[annotationid].userid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n\n            edited = annotationid;\n\n            var entry = annotations[annotationid].entry;\n\n            $('.annotation-box-' + annotationid).hide(); // Hide edited annotation-box.\n\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(annotations[annotationid].startcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(annotations[annotationid].endcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(annotations[annotationid].startoffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(annotations[annotationid].endoffset);\n            $('.annotation-form-' + entry + ' input[name=\"annotationstart\"]').val(annotations[annotationid].annotationstart);\n            $('.annotation-form-' + entry + ' input[name=\"annotationend\"]').val(annotations[annotationid].annotationend);\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(annotations[annotationid].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(annotations[annotationid].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(annotations[annotationid].suffix);\n\n            $('.annotation-form-' + entry + ' input[name=\"annotationid\"]').val(annotationid);\n\n            $('.annotation-form-' + entry + ' textarea[name=\"text\"]').val(annotations[annotationid].text);\n\n            $('.annotation-form-' + entry + ' select').val(annotations[annotationid].type);\n\n            // Prevent JavaScript injection (if annotated text in original entry is JavaScript code in script tags).\n            $('#annotationpreview-temp-' + entry).html(\n                annotations[annotationid].exact.replaceAll('<', '&lt;').replaceAll('>', '&gt;'));\n            $('#annotationpreview-temp-' + entry).css('border-color', '#' + annotations[annotationid].color);\n\n            $('.annotationarea-' + entry + ' .annotation-form').insertBefore('.annotation-box-' + annotationid);\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotationarea-' + entry + ' #id_text').focus();\n        } else {\n            $('.annotation-box-' + annotationid).focus();\n        }\n    }\n\n    /**\n     * Reset all annotation forms\n     */\n    function resetForms() {\n        $('.annotation-form').hide();\n\n        $('.annotation-form input[name^=\"annotationid\"]').val(null);\n\n        $('.annotation-form input[name^=\"startcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"endcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"startoffset\"]').val(-1);\n        $('.annotation-form input[name^=\"endoffset\"]').val(-1);\n\n        $('.annotation-form textarea[name^=\"text\"]').val('');\n\n        $('.annotation-box').not('.annotation-form').show(); // To show again edited annotation.\n    }\n};\n\n/**\n * Create a new annotation that is associated with the selected region of\n * the current document.\n *\n * @param {object} root - The root element\n * @return {object} - The new annotation\n */\nfunction createAnnotation(root) {\n    const ranges = [window.getSelection().getRangeAt(0)];\n\n    if (ranges.collapsed) {\n        return null;\n    }\n\n    const rangeSelectors = ranges.map(range => describe(root, range));\n\n    const target = rangeSelectors.map(selectors => ({\n      selector: selectors,\n    }));\n\n    /** @type {AnnotationData} */\n    const annotation = {\n      target,\n    };\n\n    anchor(annotation, root);\n\n    return annotation;\n}"],"names":["cmid","canmakeannotations","myuserid","focusannotation","edited","annotations","Array","newannotation","editAnnotation","annotationid","resetForms","userid","entry","hide","val","startcontainer","endcontainer","startoffset","endoffset","annotationstart","annotationend","exact","prefix","suffix","text","type","html","replaceAll","css","color","insertBefore","show","focus","not","removeClass","document","on","e","preventDefault","keypress","which","this","parents","submit","window","getSelection","getRangeAt","cloneContents","textContent","root","ranges","collapsed","rangeSelectors","map","range","annotation","target","selectors","selector","createAnnotation","id","replace","startContainer","endContainer","startOffset","endOffset","ajax","url","data","success","response","JSON","parse","Object","values","parseInt","recreateAnnotations","mouseenter","addClass","mouseleave","attr","complete","error"],"mappings":";;;;;;;wJA0BoB,CAACA,KAAMC,mBAAoBC,SAAUC,uBAEjDC,QAAS,EACTC,YAAcC,QAEdC,eAAgB,WAqLXC,eAAeC,iBAEhBL,QAAUK,yDAEVC,aACAN,QAAS,OACN,GAAIH,oBAAsBC,UAAYG,YAAYI,cAAcE,OAAQ,6CAE3ED,aAEAN,OAASK,iBAELG,MAAQP,YAAYI,cAAcG,0BAEpC,mBAAqBH,cAAcI,2BAEnC,oBAAsBD,MAAQ,iCAAiCE,IAAIT,YAAYI,cAAcM,oCAC7F,oBAAsBH,MAAQ,+BAA+BE,IAAIT,YAAYI,cAAcO,kCAC3F,oBAAsBJ,MAAQ,8BAA8BE,IAAIT,YAAYI,cAAcQ,iCAC1F,oBAAsBL,MAAQ,4BAA4BE,IAAIT,YAAYI,cAAcS,+BACxF,oBAAsBN,MAAQ,kCAAkCE,IAAIT,YAAYI,cAAcU,qCAC9F,oBAAsBP,MAAQ,gCAAgCE,IAAIT,YAAYI,cAAcW,mCAC5F,oBAAsBR,MAAQ,wBAAwBE,IAAIT,YAAYI,cAAcY,2BACpF,oBAAsBT,MAAQ,yBAAyBE,IAAIT,YAAYI,cAAca,4BACrF,oBAAsBV,MAAQ,yBAAyBE,IAAIT,YAAYI,cAAcc,4BAErF,oBAAsBX,MAAQ,+BAA+BE,IAAIL,kCAEjE,oBAAsBG,MAAQ,0BAA0BE,IAAIT,YAAYI,cAAce,0BAEtF,oBAAsBZ,MAAQ,WAAWE,IAAIT,YAAYI,cAAcgB,0BAGvE,2BAA6Bb,OAAOc,KAClCrB,YAAYI,cAAcY,MAAMM,WAAW,IAAK,QAAQA,WAAW,IAAK,6BAC1E,2BAA6Bf,OAAOgB,IAAI,eAAgB,IAAMvB,YAAYI,cAAcoB,2BAExF,mBAAqBjB,MAAQ,qBAAqBkB,aAAa,mBAAqBrB,kCACpF,mBAAqBG,MAAQ,qBAAqBmB,2BAClD,mBAAqBnB,MAAQ,aAAaoB,gCAE1C,mBAAqBvB,cAAcuB,iBAOpCtB,iCACH,oBAAoBG,2BAEpB,gDAAgDC,IAAI,0BAEpD,kDAAkDA,KAAK,uBACvD,gDAAgDA,KAAK,uBACrD,+CAA+CA,KAAK,uBACpD,6CAA6CA,KAAK,uBAElD,2CAA2CA,IAAI,wBAE/C,mBAAmBmB,IAAI,oBAAoBF,2BA9O/C,iCAAiCG,YAAY,gCAC7C,iCAAiCA,YAAY,gCAC7C,mCAAmCA,YAAY,kCAC/C,4BAA4BA,YAAY,2BAGxCC,UAAUC,GAAG,QAAS,cAAc,SAASC,GAC3CA,EAAEC,6DAIF5B,aAEAN,QAAS,yBAIX,YAAYmC,UAAS,SAASF,GACb,IAAXA,EAAEG,4BACAC,MAAMC,QAAQ,UAAUC,SAC1BN,EAAEC,yCAKRH,UAAUC,GAAG,UAAW,iBAAiB,cAGW,KAF9BQ,OAAOC,eAAeC,WAAW,GAEnCC,gBAAgBC,aAAsB/C,mBAAoB,6CAIxES,aAGAH,uBAsNc0C,YAChBC,OAAS,CAACN,OAAOC,eAAeC,WAAW,OAE7CI,OAAOC,iBACA,WAGLC,eAAiBF,OAAOG,KAAIC,QAAS,0BAASL,KAAMK,SAOpDC,WAAa,CACjBC,OANaJ,eAAeC,KAAII,aAChCC,SAAUD,8CAQLF,WAAYN,MAEZM,WA1OiBI,CAAiBlB,UAE7B7B,MAAQ6B,KAAKmB,GAAGC,QAAQ,SAAU,wBAGpC,oBAAsBjD,MAAQ,iCAAiCE,IAC7DP,cAAciD,OAAO,GAAGE,SAAS,GAAGI,oCACtC,oBAAsBlD,MAAQ,+BAA+BE,IAC3DP,cAAciD,OAAO,GAAGE,SAAS,GAAGK,kCACtC,oBAAsBnD,MAAQ,8BAA8BE,IAC1DP,cAAciD,OAAO,GAAGE,SAAS,GAAGM,iCACtC,oBAAsBpD,MAAQ,4BAA4BE,IACxDP,cAAciD,OAAO,GAAGE,SAAS,GAAGO,+BAGtC,oBAAsBrD,MAAQ,kCAAkCE,IAC9DP,cAAciD,OAAO,GAAGE,SAAS,GAAGvC,qCACtC,oBAAsBP,MAAQ,gCAAgCE,IAC5DP,cAAciD,OAAO,GAAGE,SAAS,GAAGtC,mCAGtC,oBAAsBR,MAAQ,wBAAwBE,IACpDP,cAAciD,OAAO,GAAGE,SAAS,GAAGrC,2BACtC,oBAAsBT,MAAQ,yBAAyBE,IACrDP,cAAciD,OAAO,GAAGE,SAAS,GAAGpC,4BACtC,oBAAsBV,MAAQ,yBAAyBE,IACrDP,cAAciD,OAAO,GAAGE,SAAS,GAAGnC,4BAEtC,oBAAsBX,MAAQ,WAAWE,IAAI,uBAG7C,2BAA6BF,OAAOc,KAClCnB,cAAciD,OAAO,GAAGE,SAAS,GAAGrC,MAAMM,WAAW,IAAK,QAAQA,WAAW,IAAK,6BAEpF,mBAAqBf,MAAQ,qBAAqBmB,2BAClD,oBAAsBnB,MAAQ,aAAaoB,4BAKnDkC,KAAK,CACHC,IAAK,oBACLC,KAAM,IAAOpE,oBAAwB,GACrCqE,QAAS,SAASC,UACdjE,YAAckE,KAAKC,MAAMF,yBAsExB,IAAIf,cAAckB,OAAOC,OAAOrE,aAAc,OAezCE,cAAgB,CAClBgD,WAAYA,WACZC,OAfmB,CAAC,CACpB,CAAC/B,KAAM,gBAAiBqC,eAAgBP,WAAWxC,eAAgBiD,YAAaW,SAASpB,WAAWtC,aACpG8C,aAAcR,WAAWvC,aAAciD,UAAWU,SAASpB,WAAWrC,YACtE,CAACO,KAAM,uBAAwBN,gBAAiBwD,SAASpB,WAAWpC,iBACpEC,cAAeuD,SAASpB,WAAWnC,gBACnC,CAACK,KAAM,oBAAqBJ,MAAOkC,WAAWlC,MAAOC,OAAQiC,WAAWjC,OAAQC,OAAQgC,WAAWhC,UAGzE8B,KAAII,aAC9BC,SAAUD,wCASPlD,eAAe,mBAAE,UAAYgD,WAAW3C,OAAO,KAzFtDgE,uBAGE,cAAcC,YAAW,eACnBjB,GAAKnB,KAAKmB,GAAGC,QAAQ,aAAc,wBACrC,mBAAqBD,IAAIkB,SAAS,+BAClC,cAAgBlB,IAAIhC,IAAI,mBAAoB,oCAGhD,cAAcmD,YAAW,eACnBnB,GAAKnB,KAAKmB,GAAGC,QAAQ,aAAc,wBACrC,mBAAqBD,IAAI1B,YAAY,+BACrC,cAAgB0B,IAAIhC,IAAI,oBAAoB,mBAAE,cAAgBgC,IAAIhC,IAAI,+CAI1EO,UAAUC,GAAG,YAAa,mBAAmB,+BACzC,mBAAmB0C,SAAS,kCAGhC3C,UAAUC,GAAG,aAAc,mBAAmB,+BAC1C,mBAAmBF,YAAY,kCAInCC,UAAUC,GAAG,QAAS,cAAc,WAElC5B,eADSiC,KAAKmB,GAAGC,QAAQ,aAAc,4BAKzC1B,UAAUC,GAAG,QAAS,oBAAoB,WAExC5B,eADSiC,KAAKmB,GAAGC,QAAQ,mBAAoB,4BAK/C1B,UAAUC,GAAG,YAAa,oBAAoB,eACxCwB,GAAKnB,KAAKmB,GAAGC,QAAQ,mBAAoB,wBAC3C,cAAgBD,IAAIhC,IAAI,mBAAoB,oCAGhDO,UAAUC,GAAG,aAAc,oBAAoB,eACzCwB,GAAKnB,KAAKmB,GAAGC,QAAQ,mBAAoB,wBAC3C,cAAgBD,IAAIhC,IAAI,oBAAoB,mBAAE,cAAgBgC,IAAIhC,IAAI,2BAKrD,GAAnBzB,sCACE,cAAgBA,iBAAiB6E,KAAK,YAAa,uBACnD,cAAgB7E,iBAAiB6B,UAI3CiD,SAAU,+BACJ,YAAYpE,QAElBqE,MAAO"}