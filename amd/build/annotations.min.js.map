{"version":3,"sources":["../src/annotations.js"],"names":["init","cmid","canmakeannotations","myuserid","edited","annotations","newannotation","removeClass","document","on","e","preventDefault","resetForms","keypress","which","parents","submit","selectedrange","window","getSelection","getRangeAt","cloneContents","textContent","createAnnotation","entry","id","replace","val","target","selector","startContainer","endContainer","startOffset","endOffset","start","end","exact","prefix","suffix","html","replaceAll","show","focus","$","ajax","url","data","success","response","JSON","parse","recreateAnnotations","mouseenter","addClass","mouseleave","editAnnotation","complete","hide","error","alert","Object","values","annotation","rangeSelectors","type","startcontainer","parseInt","startoffset","endcontainer","endoffset","map","selectors","annotationid","userid","text","css","color","insertBefore","not","root","ranges","collapsed","range"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module for the annotation functions of the margic.\n *\n * @module     mod_margic/annotations\n * @copyright  2022 coactum GmbH\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport {removeAllTempHighlights, anchor, describe} from './highlighting';\n\nexport const init = (cmid, canmakeannotations, myuserid) => {\n\n    var edited = false;\n    var annotations = Array();\n\n    var newannotation = false;\n\n    // Remove col-mds from moodle form.\n    $('.annotation-form div.col-md-3').removeClass('col-md-3');\n    $('.annotation-form div.col-md-9').removeClass('col-md-9');\n    $('.annotation-form div.form-group').removeClass('form-group');\n    $('.annotation-form div.row').removeClass('row');\n\n    // Onclick listener if form is canceled.\n    $(document).on('click', '#id_cancel', function(e) {\n        e.preventDefault();\n\n        removeAllTempHighlights(); // Remove other temporary highlights.\n\n        resetForms(); // Remove old form contents.\n\n        edited = false;\n    });\n\n    // Listen for return key pressed to submit annotation form.\n    $('textarea').keypress(function(e) {\n        if (e.which == 13) {\n            $(this).parents(':eq(2)').submit();\n            e.preventDefault();\n        }\n    });\n\n    // If user selects text for new annotation\n    $(document).on('mouseup', '.originaltext', function() {\n        var selectedrange = window.getSelection().getRangeAt(0);\n\n        if (selectedrange.cloneContents().textContent !== '' && canmakeannotations) {\n\n            removeAllTempHighlights(); // Remove other temporary highlights.\n\n            resetForms(); // Reset the annotation forms.\n\n            // Create new annotation.\n            newannotation = createAnnotation(this);\n\n            var entry = this.id.replace(/entry-/, '');\n\n            // RangeSelector.\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(\n                newannotation.target[0].selector[0].startContainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(\n                newannotation.target[0].selector[0].endContainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(\n                newannotation.target[0].selector[0].startOffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(\n                newannotation.target[0].selector[0].endOffset);\n\n            // TextPositionSelector.\n            $('.annotation-form-' + entry + ' input[name=\"start\"]').val(\n                newannotation.target[0].selector[1].start);\n            $('.annotation-form-' + entry + ' input[name=\"end\"]').val(\n                newannotation.target[0].selector[1].end);\n\n            // TextQuoteSelector.\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(\n                newannotation.target[0].selector[2].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(\n                newannotation.target[0].selector[2].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(\n                newannotation.target[0].selector[2].suffix);\n\n            $('.annotation-form-' + entry + ' select').val(1);\n\n            // Prevent JavaScript injection (if annotated text in original entry is JavaScript code in script tags).\n            $('#annotationpreview-temp-' + entry).html(\n                newannotation.target[0].selector[2].exact.replaceAll('<', '&lt;').replaceAll('>', '&gt;'));\n\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotation-form-' + entry + ' #id_text').focus();\n        }\n    });\n\n    // Fetch and recreate annotations.\n    $.ajax({\n        url: './annotations.php',\n        data: {'id': cmid, 'getannotations': 1},\n        success: function(response) {\n            annotations = JSON.parse(response);\n            recreateAnnotations();\n\n            // Highlight annotation and all annotated text if annotated text is hovered\n            $('.annotated').mouseenter(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).addClass('hovered');\n                $('.annotated-' + id).addClass('hovered');\n            });\n\n            $('.annotated').mouseleave(function() {\n                var id = this.id.replace('annotated-', '');\n                $('.annotation-box-' + id).removeClass('hovered');\n                $('.annotated-' + id).removeClass('hovered');\n            });\n\n            // Highlight whole temp annotation if part of temp annotation is hovered\n            $(document).on('mouseover', '.annotated_temp', function() {\n                $('.annotated_temp').addClass('hovered');\n            });\n\n            $(document).on('mouseleave', '.annotated_temp', function() {\n                $('.annotated_temp').removeClass('hovered');\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.annotated', function() {\n                var id = this.id.replace('annotated-', '');\n                editAnnotation(id);\n            });\n\n            // Onclick listener for editing annotation.\n            $(document).on('click', '.edit-annotation', function() {\n                var id = this.id.replace('edit-annotation-', '');\n                editAnnotation(id);\n            });\n\n            // Highlight annotation if hoverannotation button is hovered\n            $(document).on('mouseover', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).addClass('hovered');\n            });\n\n            $(document).on('mouseleave', '.hoverannotation', function() {\n                var id = this.id.replace('hoverannotation-', '');\n                $('.annotated-' + id).removeClass('hovered');\n            });\n\n        },\n        complete: function() {\n            $('#overlay').hide();\n        },\n        error: function() {\n            alert('Error fetching annotations');\n        }\n    });\n\n    /**\n     * Recreate annotations.\n     *\n     */\n    function recreateAnnotations() {\n\n        for (let annotation of Object.values(annotations)) {\n\n            const rangeSelectors = [[\n                {type: \"RangeSelector\", startContainer: annotation.startcontainer, startOffset: parseInt(annotation.startoffset),\n                endContainer: annotation.endcontainer, endOffset: parseInt(annotation.endoffset)},\n                {type: \"TextPositionSelector\", start: parseInt(annotation.start), end: parseInt(annotation.end)},\n                {type: \"TextQuoteSelector\", exact: annotation.exact, prefix: annotation.prefix, suffix: annotation.suffix}\n            ]];\n\n            const target = rangeSelectors.map(selectors => ({\n                selector: selectors,\n            }));\n\n            /** @type {AnnotationData} */\n            const newannotation = {\n                annotation: annotation,\n                target: target,\n            };\n\n            anchor(newannotation, $(\"#entry-\" + annotation.entry)[0]);\n        }\n    }\n\n    /**\n     * Edit annotation.\n     *\n     * @param {int} annotationid\n     */\n    function editAnnotation(annotationid) {\n\n        if (edited == annotationid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n            edited = false;\n        } else if (canmakeannotations && myuserid == annotations[annotationid].userid) {\n            removeAllTempHighlights(); // Remove other temporary highlights.\n            resetForms(); // Remove old form contents.\n\n            edited = annotationid;\n\n            var entry = annotations[annotationid].entry;\n\n            $('.annotation-box-' + annotationid).hide(); // Hide edited annotation-box.\n\n            $('.annotation-form-' + entry + ' input[name=\"startcontainer\"]').val(annotations[annotationid].startcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"endcontainer\"]').val(annotations[annotationid].endcontainer);\n            $('.annotation-form-' + entry + ' input[name=\"startoffset\"]').val(annotations[annotationid].startoffset);\n            $('.annotation-form-' + entry + ' input[name=\"endoffset\"]').val(annotations[annotationid].endoffset);\n            $('.annotation-form-' + entry + ' input[name=\"start\"]').val(annotations[annotationid].start);\n            $('.annotation-form-' + entry + ' input[name=\"end\"]').val(annotations[annotationid].end);\n            $('.annotation-form-' + entry + ' input[name=\"exact\"]').val(annotations[annotationid].exact);\n            $('.annotation-form-' + entry + ' input[name=\"prefix\"]').val(annotations[annotationid].prefix);\n            $('.annotation-form-' + entry + ' input[name=\"suffix\"]').val(annotations[annotationid].suffix);\n\n            $('.annotation-form-' + entry + ' input[name=\"annotationid\"]').val(annotationid);\n\n            $('.annotation-form-' + entry + ' textarea[name=\"text\"]').val(annotations[annotationid].text);\n\n            $('.annotation-form-' + entry + ' select').val(annotations[annotationid].type);\n\n            // Prevent JavaScript injection (if annotated text in original entry is JavaScript code in script tags).\n            $('#annotationpreview-temp-' + entry).html(\n                annotations[annotationid].exact.replaceAll('<', '&lt;').replaceAll('>', '&gt;'));\n            $('#annotationpreview-temp-' + entry).css('border-color', '#' + annotations[annotationid].color);\n\n            $('.annotationarea-' + entry + ' .annotation-form').insertBefore('.annotation-box-' + annotationid);\n            $('.annotationarea-' + entry + ' .annotation-form').show();\n            $('.annotationarea-' + entry + ' #id_text').focus();\n        } else {\n            $('.annotation-box-' + annotationid).focus();\n        }\n    }\n\n    /**\n     * Reset all annotation forms\n     */\n    function resetForms() {\n        $('.annotation-form').hide();\n\n        $('.annotation-form input[name^=\"annotationid\"]').val(null);\n\n        $('.annotation-form input[name^=\"startcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"endcontainer\"]').val(-1);\n        $('.annotation-form input[name^=\"startoffset\"]').val(-1);\n        $('.annotation-form input[name^=\"endoffset\"]').val(-1);\n\n        $('.annotation-form textarea[name^=\"text\"]').val('');\n\n        $('.annotation-box').not('.annotation-form').show(); // To show again edited annotation.\n    }\n};\n\n/**\n * Create a new annotation that is associated with the selected region of\n * the current document.\n *\n * @param {object} root - The root element\n * @return {object} - The new annotation\n */\nfunction createAnnotation(root) {\n    const ranges = [window.getSelection().getRangeAt(0)];\n\n    if (ranges.collapsed) {\n        return null;\n    }\n\n    const rangeSelectors = ranges.map(range => describe(root, range));\n\n    const target = rangeSelectors.map(selectors => ({\n      selector: selectors,\n    }));\n\n    /** @type {AnnotationData} */\n    const annotation = {\n      target,\n    };\n\n    anchor(annotation, root);\n\n    return annotation;\n}"],"file":"annotations.min.js"}