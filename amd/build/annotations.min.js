define("mod_margic/annotations",["exports","jquery"],(function(_exports,_jquery){var obj;function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};_exports.init=function(cmid,canmakeannotations,myuserid){var edited=!1,annotations=Array();function editAnnotation(annotationid){if(edited==annotationid)removeAllTempHighlights(),resetForms(),edited=!1;else if(canmakeannotations&&myuserid==annotations[annotationid].userid){removeAllTempHighlights(),resetForms(),edited=annotationid;var entry=annotations[annotationid].entry;(0,_jquery.default)(".annotation-box-"+annotationid).hide(),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startcontainer"]').val(annotations[annotationid].startcontainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endcontainer"]').val(annotations[annotationid].endcontainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startposition"]').val(annotations[annotationid].startposition),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endposition"]').val(annotations[annotationid].endposition),(0,_jquery.default)(".annotation-form-"+entry+' input[name="annotationid"]').val(annotationid),(0,_jquery.default)(".annotation-form-"+entry+' textarea[name="text"]').val(annotations[annotationid].text),(0,_jquery.default)(".annotation-form-"+entry+" select").val(annotations[annotationid].type),(0,_jquery.default)("#annotationpreview-temp-"+entry).html((0,_jquery.default)("#annotationpreview-"+annotationid).html()),(0,_jquery.default)("#annotationpreview-temp-"+entry).css("border-color","#"+annotations[annotationid].color),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").insertBefore(".annotation-box-"+annotationid),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").show(),(0,_jquery.default)(".annotationarea-"+entry+" #id_text").focus()}else(0,_jquery.default)(".annotation-box-"+annotationid).focus()}function resetForms(){(0,_jquery.default)(".annotation-form").hide(),(0,_jquery.default)('.annotation-form input[name^="annotationid"]').val(null),(0,_jquery.default)('.annotation-form input[name^="startcontainer"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="endcontainer"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="startposition"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="endposition"]').val(-1),(0,_jquery.default)('.annotation-form textarea[name^="text"]').val(""),(0,_jquery.default)(".annotation-box").not(".annotation-form").show()}function removeAllTempHighlights(){var highlights=Array.from((0,_jquery.default)("body")[0].querySelectorAll(".annotated_temp"));void 0!==highlights&&0!=highlights.length&&function(highlights){for(var i=0;i<highlights.length;i++)if(highlights[i].parentNode){var pn=highlights[i].parentNode,children=Array.from(highlights[i].childNodes);replaceWith(highlights[i],children),pn.normalize()}}(highlights)}function wholeTextNodesInRange(range){if(range.collapsed)return[];var root=range.commonAncestorContainer;if(root.nodeType!==Node.ELEMENT_NODE&&(root=root.parentElement),!root)return[];for(var node,textNodes=[],nodeIter=root.ownerDocument.createNodeIterator(root,NodeFilter.SHOW_TEXT);node=nodeIter.nextNode();)if(isNodeInRange(range,node)){var text=node;text===range.startContainer&&range.startOffset>0?text.splitText(range.startOffset):(text===range.endContainer&&range.endOffset<text.data.length&&text.splitText(range.endOffset),textNodes.push(text))}return textNodes}function highlightRange(range){var annotationid=arguments.length>1&&void 0!==arguments[1]&&arguments[1],cssClass=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"annotated",color=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"FFFF00",textNodes=wholeTextNodesInRange(range),textNodeSpans=[],prevNode=null,currentSpan=null;textNodes.forEach((function(node){prevNode&&prevNode.nextSibling===node?currentSpan.push(node):(currentSpan=[node],textNodeSpans.push(currentSpan)),prevNode=node}));var whitespace=/^\s*$/;textNodeSpans=textNodeSpans.filter((function(span){return span.some((function(node){return!whitespace.test(node.nodeValue)}))}));var hihglightedtext="";return textNodeSpans.forEach((function(nodes){var highlightEl=document.createElement("span");highlightEl.className=cssClass,annotationid&&(highlightEl.className+=" "+cssClass+"-"+annotationid,highlightEl.style="text-decoration:underline; text-decoration-color: #"+color,highlightEl.id=cssClass+"-"+annotationid,highlightEl.style.backgroundColor="#"+color),hihglightedtext+=nodes[0].textContent,nodes[0].parentNode.replaceChild(highlightEl,nodes[0]),nodes.forEach((function(node){return highlightEl.appendChild(node)}))})),hihglightedtext}function isNodeInRange(range,node){try{var _node$nodeValue$lengt,_node$nodeValue,length=null!==(_node$nodeValue$lengt=null===(_node$nodeValue=node.nodeValue)||void 0===_node$nodeValue?void 0:_node$nodeValue.length)&&void 0!==_node$nodeValue$lengt?_node$nodeValue$lengt:node.childNodes.length;return range.comparePoint(node,0)<=0&&range.comparePoint(node,length)>=0}catch(e){return!1}}function getPathSegment(node){var name=function(node){var nodeName=node.nodeName.toLowerCase(),result=nodeName;return"#text"===nodeName&&(result="text()"),result}(node),pos=function(node){for(var pos=0,tmp=node;tmp;)tmp.nodeName===node.nodeName&&(pos+=1),tmp=tmp.previousSibling;return pos}(node);return"".concat(name,"[").concat(pos,"]")}function xpathFromNode(node,root){for(var xpath="",elem=node;elem!==root;){if(!elem)throw new Error("Node is not a descendant of root");xpath=getPathSegment(elem)+"/"+xpath,elem=elem.parentNode}return xpath=(xpath="/"+xpath).replace(/\/$/,"")}function nthChildOfType(element,nodeName,index){nodeName=nodeName.toUpperCase();for(var matchIndex=-1,i=0;i<element.children.length;i++){var child=element.children[i];if(child.nodeName.toUpperCase()===nodeName&&++matchIndex===index)return child}return null}function evaluateSimpleXPath(xpath,root){if(!(null!==xpath.match(/^(\/[A-Za-z0-9-]+(\[[0-9]+\])?)+$/)))throw new Error("Expression is not a simple XPath");var segments=xpath.split("/"),element=root;segments.shift();var _step,_iterator=_createForOfIteratorHelper(segments);try{for(_iterator.s();!(_step=_iterator.n()).done;){var segment=_step.value,elementName=void 0,elementIndex=void 0,separatorPos=segment.indexOf("[");if(-1!==separatorPos){elementName=segment.slice(0,separatorPos);var indexStr=segment.slice(separatorPos+1,segment.indexOf("]"));if((elementIndex=parseInt(indexStr)-1)<0)return null}else elementName=segment,elementIndex=0;var child=nthChildOfType(element,elementName,elementIndex);if(!child)return null;element=child}}catch(err){_iterator.e(err)}finally{_iterator.f()}return element}function nodeFromXPath(xpath){var root=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.body;try{return evaluateSimpleXPath(xpath,root)}catch(err){return document.evaluate("."+xpath,root,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}}function replaceWith(node,replacements){var parent=node.parentNode;replacements.forEach((function(r){return parent.insertBefore(r,node)})),node.remove()}(0,_jquery.default)(".annotation-form").hide(),(0,_jquery.default)(".annotation-form div.col-md-3").removeClass("col-md-3"),(0,_jquery.default)(".annotation-form div.col-md-9").removeClass("col-md-9"),(0,_jquery.default)(".annotation-form div.form-group").removeClass("form-group"),(0,_jquery.default)(".annotation-form div.row").removeClass("row"),(0,_jquery.default)(document).on("click","#id_cancel",(function(e){e.preventDefault(),removeAllTempHighlights(),resetForms(),edited=!1})),(0,_jquery.default)("textarea").keypress((function(e){13==e.which&&((0,_jquery.default)(this).parents(":eq(2)").submit(),e.preventDefault())})),(0,_jquery.default)(document).on("mouseup",".originaltext",(function(){var selectedrange=window.getSelection().getRangeAt(0);if(""!==selectedrange.cloneContents().textContent&&canmakeannotations){removeAllTempHighlights(),resetForms();var entry=this.id.replace(/entry-/,"");(0,_jquery.default)(".annotation-form-"+entry+' input[name="startcontainer"]').val(xpathFromNode(selectedrange.startContainer,this)),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endcontainer"]').val(xpathFromNode(selectedrange.endContainer,this)),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startposition"]').val(selectedrange.startOffset),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endposition"]').val(selectedrange.endOffset),(0,_jquery.default)(".annotation-form-"+entry+" select").val(1);var annotatedtext=highlightRange(selectedrange,!1,"annotated_temp");""!=annotatedtext&&(0,_jquery.default)("#annotationpreview-temp-"+entry).html(annotatedtext),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").show(),(0,_jquery.default)(".annotation-form-"+entry+" #id_text").focus()}})),_jquery.default.ajax({url:"./annotations.php",data:{id:cmid,getannotations:1},success:function(response){annotations=JSON.parse(response),function(){for(var _i=0,_Object$values=Object.values(annotations);_i<_Object$values.length;_i++){var annotation=_Object$values[_i],newrange=document.createRange();try{newrange.setStart(nodeFromXPath(annotation.startcontainer,(0,_jquery.default)("#entry-"+annotation.entry)[0]),annotation.startposition),newrange.setEnd(nodeFromXPath(annotation.endcontainer,(0,_jquery.default)("#entry-"+annotation.entry)[0]),annotation.endposition)}catch(e){}var annotatedtext=highlightRange(newrange,annotation.id,"annotated",annotation.color);""!=annotatedtext&&(0,_jquery.default)("#annotationpreview-"+annotation.id).html(annotatedtext)}}(),(0,_jquery.default)(".annotated").mouseenter((function(){var id=this.id.replace("annotated-","");(0,_jquery.default)(".annotationpreview-"+id).addClass("hovered"),(0,_jquery.default)(".annotated-"+id).addClass("hovered"),(0,_jquery.default)(".annotation-box-"+id+" .errortype").addClass("hovered")})),(0,_jquery.default)(".annotated").mouseleave((function(){var id=this.id.replace("annotated-","");(0,_jquery.default)(".annotationpreview-"+id).removeClass("hovered"),(0,_jquery.default)(".annotated-"+id).removeClass("hovered"),(0,_jquery.default)(".annotation-box-"+id+" .errortype").removeClass("hovered")})),(0,_jquery.default)(".annotatedtextpreview").mouseenter((function(){var id=this.id.replace("annotationpreview-","");(0,_jquery.default)(".annotated-"+id).addClass("hovered")})),(0,_jquery.default)(".annotatedtextpreview").mouseleave((function(){var id=this.id.replace("annotationpreview-","");(0,_jquery.default)(".annotated-"+id).removeClass("hovered")})),(0,_jquery.default)(document).on("mouseover",".annotated_temp",(function(){(0,_jquery.default)(".annotated_temp").addClass("hovered")})),(0,_jquery.default)(document).on("mouseleave",".annotated_temp",(function(){(0,_jquery.default)(".annotated_temp").removeClass("hovered")})),(0,_jquery.default)(document).on("click",".annotated",(function(){editAnnotation(this.id.replace("annotated-",""))})),(0,_jquery.default)(document).on("click",".edit-annotation",(function(){editAnnotation(this.id.replace("edit-annotation-",""))}))},error:function(){alert("Error fetiching annotations")}})}}));

//# sourceMappingURL=annotations.min.js.map