define("mod_margic/annotations",["exports","jquery","./types","./text-range"],(function(_exports,_jquery,_types2,_textRange){var obj;function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.describe=describe,_exports.init=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};function describe(root,range){for(var result=[],_i2=0,_types=[_types2.RangeAnchor,_types2.TextPositionAnchor,_types2.TextQuoteAnchor];_i2<_types.length;_i2++){var type=_types[_i2];try{var _anchor=type.fromRange(root,range);result.push(_anchor.toSelector())}catch(error){continue}}return result}function anchor(annotation,root){var highlight=function(anchor){var range=function(anchor){if(!anchor.range)return null;try{return anchor.range.toRange()}catch(_unused){return null}}(anchor);if(range){var highlights=[];(highlights=annotation.annotation?highlightRange(range,annotation.annotation.id,"annotated",annotation.annotation.color):highlightRange(range,!1,"annotated_temp")).forEach((function(h){h._annotation=anchor.annotation})),anchor.highlights=highlights}};annotation.target||(annotation.target=[]);var _step2,anchors=annotation.target.map((function(target){if(!target.selector||!target.selector.some((function(s){return"TextQuoteSelector"===s.type})))return{annotation:annotation,target:target};var anchor;try{var range=function(root,selectors){var _step3,options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},position=null,quote=null,range=null,_iterator3=_createForOfIteratorHelper(selectors);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var selector=_step3.value;switch(selector.type){case"TextPositionSelector":position=selector,options.hint=position.start;break;case"TextQuoteSelector":quote=selector;break;case"RangeSelector":range=selector}}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}var maybeAssertQuote=function(range){var _quote;if(null!==(_quote=quote)&&void 0!==_quote&&_quote.exact&&range.toString()!==quote.exact)throw new Error("quote mismatch");return range};if(range){return querySelector(_types2.RangeAnchor.fromSelector(root,range),options)||maybeAssertQuote}if(position){return querySelector(_types2.TextPositionAnchor.fromSelector(root,position),options)||maybeAssertQuote}if(quote){return querySelector(_types2.TextQuoteAnchor.fromSelector(root,quote),options)}return!1}(root,target.selector),textRange=_textRange.TextRange.fromRange(range);anchor={annotation:annotation,target:target,range:textRange}}catch(err){anchor={annotation:annotation,target:target}}return anchor})),_iterator2=_createForOfIteratorHelper(anchors);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){highlight(_step2.value)}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return annotation.$orphan=anchors.length>0&&anchors.every((function(anchor){return anchor.target.selector&&!anchor.range})),anchors}function highlightRange(range){var annotationid=arguments.length>1&&void 0!==arguments[1]&&arguments[1],cssClass=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"annotated",color=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"FFFF00",textNodes=wholeTextNodesInRange(range),textNodeSpans=[],prevNode=null,currentSpan=null;textNodes.forEach((function(node){prevNode&&prevNode.nextSibling===node?currentSpan.push(node):(currentSpan=[node],textNodeSpans.push(currentSpan)),prevNode=node}));var whitespace=/^\s*$/;textNodeSpans=textNodeSpans.filter((function(span){return span.some((function(node){return!whitespace.test(node.nodeValue)}))}));var highlights=[];return textNodeSpans.forEach((function(nodes){var highlightEl=document.createElement("margic-highlight");highlightEl.className=cssClass,annotationid&&(highlightEl.className+=" "+cssClass+"-"+annotationid,highlightEl.style="text-decoration:underline; text-decoration-color: #"+color,highlightEl.id=cssClass+"-"+annotationid,highlightEl.style.backgroundColor="#"+color),nodes[0].parentNode.replaceChild(highlightEl,nodes[0]),nodes.forEach((function(node){return highlightEl.appendChild(node)})),highlights.push(highlightEl)})),highlights}function wholeTextNodesInRange(range){if(range.collapsed)return[];var root=range.commonAncestorContainer;if(root.nodeType!==Node.ELEMENT_NODE&&(root=root.parentElement),!root)return[];for(var node,textNodes=[],nodeIter=root.ownerDocument.createNodeIterator(root,NodeFilter.SHOW_TEXT);node=nodeIter.nextNode();)if(isNodeInRange(range,node)){var text=node;text===range.startContainer&&range.startOffset>0?text.splitText(range.startOffset):(text===range.endContainer&&range.endOffset<text.data.length&&text.splitText(range.endOffset),textNodes.push(text))}return textNodes}function isNodeInRange(range,node){try{var _node$nodeValue$lengt,_node$nodeValue,length=null!==(_node$nodeValue$lengt=null===(_node$nodeValue=node.nodeValue)||void 0===_node$nodeValue?void 0:_node$nodeValue.length)&&void 0!==_node$nodeValue$lengt?_node$nodeValue$lengt:node.childNodes.length;return range.comparePoint(node,0)<=0&&range.comparePoint(node,length)>=0}catch(e){return!1}}function querySelector(anchor){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return anchor.toRange(options)}_exports.init=function(cmid,canmakeannotations,myuserid){var edited=!1,annotations=Array(),newannotation=!1;function editAnnotation(annotationid){if(edited==annotationid)removeAllTempHighlights(),resetForms(),edited=!1;else if(canmakeannotations&&myuserid==annotations[annotationid].userid){removeAllTempHighlights(),resetForms(),edited=annotationid;var entry=annotations[annotationid].entry;(0,_jquery.default)(".annotation-box-"+annotationid).hide(),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startcontainer"]').val(annotations[annotationid].startcontainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endcontainer"]').val(annotations[annotationid].endcontainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startoffset"]').val(annotations[annotationid].startoffset),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endoffset"]').val(annotations[annotationid].endoffset),(0,_jquery.default)(".annotation-form-"+entry+' input[name="start"]').val(annotations[annotationid].start),(0,_jquery.default)(".annotation-form-"+entry+' input[name="end"]').val(annotations[annotationid].end),(0,_jquery.default)(".annotation-form-"+entry+' input[name="exact"]').val(annotations[annotationid].exact),(0,_jquery.default)(".annotation-form-"+entry+' input[name="prefix"]').val(annotations[annotationid].prefix),(0,_jquery.default)(".annotation-form-"+entry+' input[name="suffix"]').val(annotations[annotationid].suffix),(0,_jquery.default)(".annotation-form-"+entry+' input[name="annotationid"]').val(annotationid),(0,_jquery.default)(".annotation-form-"+entry+' textarea[name="text"]').val(annotations[annotationid].text),(0,_jquery.default)(".annotation-form-"+entry+" select").val(annotations[annotationid].type),(0,_jquery.default)("#annotationpreview-temp-"+entry).html((0,_jquery.default)("#annotationpreview-"+annotationid).html()),(0,_jquery.default)("#annotationpreview-temp-"+entry).css("border-color","#"+annotations[annotationid].color),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").insertBefore(".annotation-box-"+annotationid),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").show(),(0,_jquery.default)(".annotationarea-"+entry+" #id_text").focus()}else(0,_jquery.default)(".annotation-box-"+annotationid).focus()}function resetForms(){(0,_jquery.default)(".annotation-form").hide(),(0,_jquery.default)('.annotation-form input[name^="annotationid"]').val(null),(0,_jquery.default)('.annotation-form input[name^="startcontainer"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="endcontainer"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="startoffset"]').val(-1),(0,_jquery.default)('.annotation-form input[name^="endoffset"]').val(-1),(0,_jquery.default)('.annotation-form textarea[name^="text"]').val(""),(0,_jquery.default)(".annotation-box").not(".annotation-form").show()}function removeAllTempHighlights(){var highlights=Array.from((0,_jquery.default)("body")[0].querySelectorAll(".annotated_temp"));void 0!==highlights&&0!=highlights.length&&function(highlights){for(var i=0;i<highlights.length;i++)if(highlights[i].parentNode){var pn=highlights[i].parentNode,children=Array.from(highlights[i].childNodes);replaceWith(highlights[i],children),pn.normalize()}}(highlights)}function replaceWith(node,replacements){var parent=node.parentNode;replacements.forEach((function(r){return parent.insertBefore(r,node)})),node.remove()}(0,_jquery.default)(".annotation-form").hide(),(0,_jquery.default)(".annotation-form div.col-md-3").removeClass("col-md-3"),(0,_jquery.default)(".annotation-form div.col-md-9").removeClass("col-md-9"),(0,_jquery.default)(".annotation-form div.form-group").removeClass("form-group"),(0,_jquery.default)(".annotation-form div.row").removeClass("row"),(0,_jquery.default)(document).on("click","#id_cancel",(function(e){e.preventDefault(),removeAllTempHighlights(),resetForms(),edited=!1})),(0,_jquery.default)("textarea").keypress((function(e){13==e.which&&((0,_jquery.default)(this).parents(":eq(2)").submit(),e.preventDefault())})),(0,_jquery.default)(document).on("mouseup",".originaltext",(function(){if(""!==window.getSelection().getRangeAt(0).cloneContents().textContent&&canmakeannotations){removeAllTempHighlights(),resetForms(),newannotation=function(root){var ranges=[window.getSelection().getRangeAt(0)];if(ranges.collapsed)return null;var annotation={target:ranges.map((function(range){return describe(root,range)})).map((function(selectors){return{selector:selectors}}))};return temp=anchor(annotation,root),annotation}(this);var entry=this.id.replace(/entry-/,"");(0,_jquery.default)(".annotation-form-"+entry+' input[name="startcontainer"]').val(newannotation.target[0].selector[0].startContainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endcontainer"]').val(newannotation.target[0].selector[0].endContainer),(0,_jquery.default)(".annotation-form-"+entry+' input[name="startoffset"]').val(newannotation.target[0].selector[0].startOffset),(0,_jquery.default)(".annotation-form-"+entry+' input[name="endoffset"]').val(newannotation.target[0].selector[0].endOffset),(0,_jquery.default)(".annotation-form-"+entry+' input[name="start"]').val(newannotation.target[0].selector[1].start),(0,_jquery.default)(".annotation-form-"+entry+' input[name="end"]').val(newannotation.target[0].selector[1].end),(0,_jquery.default)(".annotation-form-"+entry+' input[name="exact"]').val(newannotation.target[0].selector[2].exact),(0,_jquery.default)(".annotation-form-"+entry+' input[name="prefix"]').val(newannotation.target[0].selector[2].prefix),(0,_jquery.default)(".annotation-form-"+entry+' input[name="suffix"]').val(newannotation.target[0].selector[2].suffix),(0,_jquery.default)(".annotation-form-"+entry+" select").val(1),(0,_jquery.default)("#annotationpreview-temp-"+entry).html(newannotation.target[0].selector[2].exact),(0,_jquery.default)(".annotationarea-"+entry+" .annotation-form").show(),(0,_jquery.default)(".annotation-form-"+entry+" #id_text").focus()}})),_jquery.default.ajax({url:"./annotations.php",data:{id:cmid,getannotations:1},success:function(response){annotations=JSON.parse(response),function(){for(var _i=0,_Object$values=Object.values(annotations);_i<_Object$values.length;_i++){var annotation=_Object$values[_i];anchor({annotation:annotation,target:[[{type:"RangeSelector",startContainer:annotation.startcontainer,startOffset:annotation.startoffset,endContainer:annotation.endcontainer,endOffset:annotation.endoffset},{type:"TextPositionSelector",start:annotation.start,end:annotation.end},{type:"TextQuoteSelector",exact:annotation.exact,prefix:annotation.prefix,suffix:annotation.suffix}]].map((function(selectors){return{selector:selectors}}))},(0,_jquery.default)("#entry-"+annotation.entry)[0]),(0,_jquery.default)("#annotationpreview-"+annotation.id).html(annotation.exact)}}(),(0,_jquery.default)(".annotated").mouseenter((function(){var id=this.id.replace("annotated-","");(0,_jquery.default)(".annotation-box-"+id).addClass("hovered"),(0,_jquery.default)(".annotated-"+id).addClass("hovered")})),(0,_jquery.default)(".annotated").mouseleave((function(){var id=this.id.replace("annotated-","");(0,_jquery.default)(".annotation-box-"+id).removeClass("hovered"),(0,_jquery.default)(".annotated-"+id).removeClass("hovered")})),(0,_jquery.default)(document).on("mouseover",".annotated_temp",(function(){(0,_jquery.default)(".annotated_temp").addClass("hovered")})),(0,_jquery.default)(document).on("mouseleave",".annotated_temp",(function(){(0,_jquery.default)(".annotated_temp").removeClass("hovered")})),(0,_jquery.default)(document).on("click",".annotated",(function(){editAnnotation(this.id.replace("annotated-",""))})),(0,_jquery.default)(document).on("click",".edit-annotation",(function(){editAnnotation(this.id.replace("edit-annotation-",""))})),(0,_jquery.default)(document).on("mouseover",".hoverannotation",(function(){var id=this.id.replace("hoverannotation-","");(0,_jquery.default)(".annotated-"+id).addClass("hovered")})),(0,_jquery.default)(document).on("mouseleave",".hoverannotation",(function(){var id=this.id.replace("hoverannotation-","");(0,_jquery.default)(".annotated-"+id).removeClass("hovered")}))},error:function(){alert("Error fetiching annotations")}})}}));

//# sourceMappingURL=annotations.min.js.map