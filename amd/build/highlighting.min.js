define("mod_margic/highlighting",["exports","jquery","./types","./text-range"],(function(_exports,_jquery,_types,_textRange){var obj;function highlightRange(range){let annotationid=arguments.length>1&&void 0!==arguments[1]&&arguments[1],cssClass=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"annotated",color=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"FFFF00";const textNodes=function(range){if(range.collapsed)return[];let root=range.commonAncestorContainer;root.nodeType!==Node.ELEMENT_NODE&&(root=root.parentElement);if(!root)return[];const textNodes=[],nodeIter=root.ownerDocument.createNodeIterator(root,NodeFilter.SHOW_TEXT);let node;for(;node=nodeIter.nextNode();){if(!isNodeInRange(range,node))continue;let text=node;text===range.startContainer&&range.startOffset>0?text.splitText(range.startOffset):(text===range.endContainer&&range.endOffset<text.data.length&&text.splitText(range.endOffset),textNodes.push(text))}return textNodes}(range);let textNodeSpans=[],prevNode=null,currentSpan=null;textNodes.forEach((node=>{prevNode&&prevNode.nextSibling===node?currentSpan.push(node):(currentSpan=[node],textNodeSpans.push(currentSpan)),prevNode=node}));const whitespace=/^\s*$/;textNodeSpans=textNodeSpans.filter((span=>span.some((node=>!whitespace.test(node.nodeValue)))));const highlights=[];return textNodeSpans.forEach((nodes=>{const highlightEl=document.createElement("margic-highlight");highlightEl.className=cssClass,annotationid&&(highlightEl.className+=" "+cssClass+"-"+annotationid,highlightEl.style="text-decoration:underline; text-decoration-color: #"+color,highlightEl.id=cssClass+"-"+annotationid,highlightEl.style.backgroundColor="#"+color);nodes[0].parentNode.replaceChild(highlightEl,nodes[0]),nodes.forEach((node=>highlightEl.appendChild(node))),highlights.push(highlightEl)})),highlights}function isNodeInRange(range,node){try{var _node$nodeValue$lengt,_node$nodeValue;const length=null!==(_node$nodeValue$lengt=null===(_node$nodeValue=node.nodeValue)||void 0===_node$nodeValue?void 0:_node$nodeValue.length)&&void 0!==_node$nodeValue$lengt?_node$nodeValue$lengt:node.childNodes.length;return range.comparePoint(node,0)<=0&&range.comparePoint(node,length)>=0}catch(e){return!1}}function querySelector(anchor){let options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return anchor.toRange(options)}function replaceWith(node,replacements){const parent=node.parentNode;replacements.forEach((r=>parent.insertBefore(r,node))),node.remove()}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.anchor=function(annotation,root){const highlight=anchor=>{const range=function(anchor){if(!anchor.range)return null;try{return anchor.range.toRange()}catch{return null}}(anchor);if(!range)return;let highlights=[];highlights=annotation.annotation?highlightRange(range,annotation.annotation.id,"annotated",annotation.annotation.color):highlightRange(range,!1,"annotated_temp"),highlights.forEach((h=>{h._annotation=anchor.annotation})),anchor.highlights=highlights};annotation.target||(annotation.target=[]);const anchors=annotation.target.map((target=>{if(!target.selector||!target.selector.some((s=>"TextQuoteSelector"===s.type)))return{annotation:annotation,target:target};let anchor;try{const range=function(root,selectors){let options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},position=null,quote=null,range=null;for(let selector of selectors)switch(selector.type){case"TextPositionSelector":position=selector,options.hint=position.start;break;case"TextQuoteSelector":quote=selector;break;case"RangeSelector":range=selector}const maybeAssertQuote=range=>{var _quote;if(null!==(_quote=quote)&&void 0!==_quote&&_quote.exact&&range.toString()!==quote.exact)throw new Error("quote mismatch");return range};let queryselector=!1;try{if(range)return queryselector=querySelector(_types.RangeAnchor.fromSelector(root,range),options),queryselector||maybeAssertQuote}catch(error){try{if(position)return queryselector=querySelector(_types.TextPositionAnchor.fromSelector(root,position),options),queryselector||maybeAssertQuote}catch(error){try{if(quote)return queryselector=querySelector(_types.TextQuoteAnchor.fromSelector(root,quote),options),queryselector}catch(error){return!1}}}return!1}(root,target.selector),textRange=_textRange.TextRange.fromRange(range);anchor={annotation:annotation,target:target,range:textRange}}catch(err){anchor={annotation:annotation,target:target}}return anchor}));for(let anchor of anchors)highlight(anchor);return annotation.$orphan=anchors.length>0&&anchors.every((anchor=>anchor.target.selector&&!anchor.range)),anchors},_exports.describe=function(root,range){const types=[_types.RangeAnchor,_types.TextPositionAnchor,_types.TextQuoteAnchor],result=[];for(let type of types)try{const anchor=type.fromRange(root,range);result.push(anchor.toSelector())}catch(error){continue}return result},_exports.removeAllTempHighlights=function(){const highlights=Array.from((0,_jquery.default)("body")[0].querySelectorAll(".annotated_temp"));void 0!==highlights&&0!=highlights.length&&function(highlights){for(var i=0;i<highlights.length;i++)if(highlights[i].parentNode){const children=Array.from(highlights[i].childNodes);replaceWith(highlights[i],children)}}(highlights)},_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}}));

//# sourceMappingURL=highlighting.min.js.map