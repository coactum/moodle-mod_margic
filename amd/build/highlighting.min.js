define("mod_margic/highlighting",["exports","jquery","./types","./text-range"],(function(_exports,_jquery,_types2,_textRange){var obj;function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function highlightRange(range){var annotationid=arguments.length>1&&void 0!==arguments[1]&&arguments[1],cssClass=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"annotated",color=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"FFFF00",textNodes=wholeTextNodesInRange(range),textNodeSpans=[],prevNode=null,currentSpan=null;textNodes.forEach((function(node){prevNode&&prevNode.nextSibling===node?currentSpan.push(node):(currentSpan=[node],textNodeSpans.push(currentSpan)),prevNode=node}));var whitespace=/^\s*$/;textNodeSpans=textNodeSpans.filter((function(span){return span.some((function(node){return!whitespace.test(node.nodeValue)}))}));var highlights=[];return textNodeSpans.forEach((function(nodes){var highlightEl=document.createElement("margic-highlight");highlightEl.className=cssClass,annotationid&&(highlightEl.className+=" "+cssClass+"-"+annotationid,highlightEl.style="text-decoration:underline; text-decoration-color: #"+color,highlightEl.id=cssClass+"-"+annotationid,highlightEl.style.backgroundColor="#"+color),nodes[0].parentNode.replaceChild(highlightEl,nodes[0]),nodes.forEach((function(node){return highlightEl.appendChild(node)})),highlights.push(highlightEl)})),highlights}function wholeTextNodesInRange(range){if(range.collapsed)return[];var root=range.commonAncestorContainer;if(root.nodeType!==Node.ELEMENT_NODE&&(root=root.parentElement),!root)return[];for(var node,textNodes=[],nodeIter=root.ownerDocument.createNodeIterator(root,NodeFilter.SHOW_TEXT);node=nodeIter.nextNode();)if(isNodeInRange(range,node)){var text=node;text===range.startContainer&&range.startOffset>0?text.splitText(range.startOffset):(text===range.endContainer&&range.endOffset<text.data.length&&text.splitText(range.endOffset),textNodes.push(text))}return textNodes}function isNodeInRange(range,node){try{var _node$nodeValue$lengt,_node$nodeValue,length=null!==(_node$nodeValue$lengt=null===(_node$nodeValue=node.nodeValue)||void 0===_node$nodeValue?void 0:_node$nodeValue.length)&&void 0!==_node$nodeValue$lengt?_node$nodeValue$lengt:node.childNodes.length;return range.comparePoint(node,0)<=0&&range.comparePoint(node,length)>=0}catch(e){return!1}}function querySelector(anchor){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return anchor.toRange(options)}function replaceWith(node,replacements){var parent=node.parentNode;replacements.forEach((function(r){return parent.insertBefore(r,node)})),node.remove()}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.anchor=function(annotation,root){var highlight=function(anchor){var range=function(anchor){if(!anchor.range)return null;try{return anchor.range.toRange()}catch(_unused){return null}}(anchor);if(range){var highlights=[];(highlights=annotation.annotation?highlightRange(range,annotation.annotation.id,"annotated",annotation.annotation.color):highlightRange(range,!1,"annotated_temp")).forEach((function(h){h._annotation=anchor.annotation})),anchor.highlights=highlights}};annotation.target||(annotation.target=[]);var _step,anchors=annotation.target.map((function(target){if(!target.selector||!target.selector.some((function(s){return"TextQuoteSelector"===s.type})))return{annotation:annotation,target:target};var anchor;try{var range=function(root,selectors){var _step2,options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},position=null,quote=null,range=null,_iterator2=_createForOfIteratorHelper(selectors);try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var selector=_step2.value;switch(selector.type){case"TextPositionSelector":position=selector,options.hint=position.start;break;case"TextQuoteSelector":quote=selector;break;case"RangeSelector":range=selector}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}var maybeAssertQuote=function(range){var _quote;if(null!==(_quote=quote)&&void 0!==_quote&&_quote.exact&&range.toString()!==quote.exact)throw new Error("quote mismatch");return range};return range?querySelector(_types2.RangeAnchor.fromSelector(root,range),options)||maybeAssertQuote:position?querySelector(_types2.TextPositionAnchor.fromSelector(root,position),options)||maybeAssertQuote:!!quote&&querySelector(_types2.TextQuoteAnchor.fromSelector(root,quote),options)}(root,target.selector),textRange=_textRange.TextRange.fromRange(range);anchor={annotation:annotation,target:target,range:textRange}}catch(err){anchor={annotation:annotation,target:target}}return anchor})),_iterator=_createForOfIteratorHelper(anchors);try{for(_iterator.s();!(_step=_iterator.n()).done;){var _anchor2=_step.value;highlight(_anchor2)}}catch(err){_iterator.e(err)}finally{_iterator.f()}return annotation.$orphan=anchors.length>0&&anchors.every((function(anchor){return anchor.target.selector&&!anchor.range})),anchors},_exports.describe=function(root,range){for(var types=[_types2.RangeAnchor,_types2.TextPositionAnchor,_types2.TextQuoteAnchor],result=[],_i=0,_types=types;_i<_types.length;_i++){var type=_types[_i];try{var _anchor=type.fromRange(root,range);result.push(_anchor.toSelector())}catch(error){continue}}return result},_exports.removeAllTempHighlights=function(){var highlights=Array.from((0,_jquery.default)("body")[0].querySelectorAll(".annotated_temp"));void 0!==highlights&&0!=highlights.length&&function(highlights){for(var i=0;i<highlights.length;i++)if(highlights[i].parentNode){var pn=highlights[i].parentNode,children=Array.from(highlights[i].childNodes);replaceWith(highlights[i],children),pn.normalize()}}(highlights)},_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj}}));

//# sourceMappingURL=highlighting.min.js.map